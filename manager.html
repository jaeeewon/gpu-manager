<head>
    <title>LangAI GPU 복구</title>
</head>

<h1>wakeup 4090 😭</h1>
<h4>GPU가 어떤 이유에선지 자꾸 죽는데,, 매번 제가 살릴 수 없어서 만들었습니다</h4>

<label for="instance">인스턴스를 선택하세요</label>
<select onchange="clearVisibles()" id="instance">
    <option value="1">hufs01</option>
    <option value="2">hufs02</option>
    <option value="3">hufs03</option>
    <option value="4">hufs04</option>
</select>

<button onclick="getGpuStatus()">GPU 상태 불러오기</button>
<button style="display: none;" id="reset" onclick="resetInstance()">인스턴스 재시작(문제 해결하기)</button>

<pre id="output" style="margin-top: 20px; padding: 10px;"></pre>

<script>
    const pre = document.getElementById('output')
    const reset = document.getElementById('reset')
    let PASSWORD = '';

    function pwAssertion() {
        while (PASSWORD.length !== 4) PASSWORD = prompt(PASSWORD === 'unauth' ? '비밀번호 오류! 다시 입력' : '비밀번호 입력')
    }

    function setStatus(stdout) {
        const isOk = !stdout.includes('Failed to initialize NVML: Unknown Error')
        pre.textContent = stdout;
        pre.style.color = isOk ? 'green' : 'red'
        reset.style.display = isOk ? 'none' : ''
    }

    function clearVisibles() {
        pre.textContent = '';
        reset.style.display = 'none'
    }

    async function getGpuStatus() {
        clearVisibles()
        pwAssertion()
        const no = document.getElementById('instance').value;
        const res = await fetch(`/get-gpu-status?no=${no}&pass=${PASSWORD}`);

        if (res.status === 401) {
            PASSWORD = 'unauth';
            return await getGpuStatus()
        }

        const json = await res.json();
        setStatus(json.success ? json.data.stdout : 'Error: ' + json.message);
    }

    async function resetInstance() {
        clearVisibles()
        pwAssertion()
        const no = document.getElementById('instance').value;
        const res = await fetch(`/reset-instance?no=${no}&pass=${PASSWORD}`, { method: 'POST' });

        if (res.status === 401) {
            PASSWORD = 'unauth';
            return await resetInstance()
        }

        const json = await res.json();
        setStatus(json.success ? json.data.stdout : 'Error: ' + json.message);
    }
</script>